<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gioco Obblighi - Estrazione da Google Sheet</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    padding: 10px;
  }
  input.obbligo {
    width: 100%;
    font-size: 16px;
    margin: 4px 0 12px;
  }
  input.obbligo[type=password] {
    letter-spacing: 0.3em; /* per mostrare bene i pallini */
  }
  #estratti {
    margin-top: 20px;
    font-weight: bold;
    border-top: 1px solid #ccc;
    padding-top: 15px;
  }
  button {
    margin: 5px 10px 15px 0;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
  }
  #obblighiDiv > div {
    margin-bottom: 15px;
  }
  #obblighiDiv > div > strong {
    display: block;
    margin-bottom: 5px;
  }
</style>
</head>
<body>
<h1>Gioco Obblighi - Estrazione</h1>

<button id="caricaBtn">Carica obblighi dal Google Sheet</button>
<button id="estraiBtn" disabled>Estrai obbligo</button>

<div id="obblighiDiv"></div>
<div id="estratti"></div>

<script>
  // === METTI QUI IL TUO ID GOOGLE SHEET ===
  const sheetId = '13-hrE3BjeoEFzsVJfGJpXYeqsNS7RnfiPtFGwvGW1YQ';

  let obblighi = [];  // array di {nome, obbligo1, obbligo2}
  let estrattiSet = new Set();
  let estrattiCount = 0;

  const caricaBtn = document.getElementById('caricaBtn');
  const estraiBtn = document.getElementById('estraiBtn');
  const obblighiDiv = document.getElementById('obblighiDiv');
  const estrattiDiv = document.getElementById('estratti');

  caricaBtn.addEventListener('click', () => {
    caricaBtn.disabled = true;
    estrattiDiv.innerHTML = '';
    estrattiSet.clear();
    estrattiCount = 0;

    fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=Sheet1&tqx=out:json`)
      .then(res => res.text())
      .then(text => {
        // Estraggo JSON pulito da risposta Google
        const jsonData = JSON.parse(text.substr(47).slice(0, -2));
        const rows = jsonData.table.rows;
        obblighi = rows.map(r => ({
          nome: r.c[0] ? r.c[0].v : '',
          obbligo1: r.c[1] ? r.c[1].v : '',
          obbligo2: r.c[2] ? r.c[2].v : '',
        }));
        mostraObblighiNascosti();
        estraiBtn.disabled = false;
      })
      .catch(e => {
        alert('Errore caricamento dati: ' + e);
        caricaBtn.disabled = false;
      });
  });

  function mostraObblighiNascosti() {
    obblighiDiv.innerHTML = '';
    obblighi.forEach(o => {
      const container = document.createElement('div');

      const nomeEl = document.createElement('strong');
      nomeEl.textContent = o.nome;
      container.appendChild(nomeEl);

      const input1 = document.createElement('input');
      input1.type = 'password';
      input1.className = 'obbligo';
      input1.value = o.obbligo1;
      input1.readOnly = true;
      container.appendChild(input1);

      const input2 = document.createElement('input');
      input2.type = 'password';
      input2.className = 'obbligo';
      input2.value = o.obbligo2;
      input2.readOnly = true;
      container.appendChild(input2);

      obblighiDiv.appendChild(container);
    });
  }

  estraiBtn.addEventListener('click', () => {
    if (estrattiCount >= obblighi.length * 2) {
      alert('Tutti gli obblighi sono stati estratti!');
      estraiBtn.disabled = true;
      return;
    }

    let estratto;
    do {
      // Pesco random persona e obbligo 1 o 2
      const personaIdx = Math.floor(Math.random() * obblighi.length);
      const obbligoN = Math.floor(Math.random() * 2) + 1;
      estratto = `${obblighi[personaIdx].nome} - obbligo ${obbligoN}`;
    } while (estrattiSet.has(estratto));

    estrattiSet.add(estratto);
    estrattiCount++;

    // Prendo testo obbligo reale per mostrarlo
    const personaIdx = obblighi.findIndex(o => estratto.startsWith(o.nome));
    const obbligoN = estratto.includes('obbligo 1') ? 1 : 2;
    const testoObbligo = obblighi[personaIdx][`obbligo${obbligoN}`];

    // Aggiungo estrazione sotto le precedenti
    estrattiDiv.innerHTML += `<div>${estratto}: <b>${testoObbligo}</b></div>`;
  });
</script>

</body>
</html>
